# 外网通过域名/公网IPv6访问内网VMware虚拟机 实施方案
## 一、需求定义
在 **VMware NAT 网络模式** 下，基于 Win10 宿主机搭建端口转发与反向代理体系，实现以下三类访问路径：
1.  内网访问：`http://192.168.33.100:3335` → 转发至虚拟机 `http://192.168.100.101:335`
2.  公网IPv6访问：`https://[公网IPv6]:3335` → 转到虚拟机 `http://192.168.100.101:335`
3.  域名访问：`https://web.vm.xds.net` → 映射至虚拟机 `http://192.168.100.101:335`

## 二、方案背景与逻辑链路
### 1. 网络环境前提
宿主机已获取 **公网IPv6地址**，虚拟机采用 VMware NAT 模式组网，与宿主机处于不同内网网段。

### 2. 核心技术选型
采用 **Lucky 工具** 实现动态域名解析（DDNS）+ 反向代理，解决两大核心问题：
- 公网IPv6地址动态变化的域名绑定问题
- 运营商封禁443端口后，外网无端口访问的需求

### 3. 完整数据转发链路
```
https://web.vm.xds.net（外网域名请求）
  ↓  Cloudflare CDN 转发（仅支持 443/2053 等合规HTTPS端口）
https://web.vm.xds.net:2053（Lucky 443→2053 端口映射）
  ↓  Lucky 反向代理转发
http://192.168.33.100:3335（宿主机内网端口）
  ↓  VMware NAT 端口转发
http://192.168.100.101:335（目标虚拟机服务端口）
```

## 三、分步实施步骤
### 1. VMware NAT 端口转发配置
**目标**：建立宿主机与虚拟机的端口映射关系
1.  打开 VMware → 顶部菜单栏 **编辑** → **虚拟网络编辑器**
2.  选择 **VMnet8（NAT模式）** → 点击 **NAT设置** → 进入 **端口转发** 界面
3.  添加端口转发规则，示例配置如下：
    | 服务名称 | 宿主机端口 | 虚拟机地址与端口 |
    |----------|------------|------------------|
    | Docker   | 9000       | 192.168.100.102:9000 |
    | HydroOJ  | 8081       | 192.168.100.103:80 |
    | RayOJ    | 8080       | 192.168.100.104:80 |
    | WebServer | 3335       | 192.168.100.101:335 |
4.  保存配置并重启 VMware 网络服务

### 2. Win10 宿主机防火墙入站规则配置
**目标**：放行外网访问的端口流量
1.  以管理员身份运行 **CMD**，执行命令 `wf.msc` 打开 **高级安全 Windows Defender 防火墙**
2.  左侧导航栏选择 **入站规则** → 右侧点击 **新建规则**
3.  规则类型选择 **端口** → 协议选择 **TCP** → 勾选 **特定本地端口**，输入需放行端口：**`443,2053,8080,8081,9000,3335`**
4.  选择 **允许连接** → 勾选 **域、专用、公网** → 命名规则后完成创建

### 3. 路由器 ACL 规则配置（以 iKuai 为例）
**目标**：精细化管控 IPv6 流量，仅允许指定端口与宿主机的访问
#### 3.1 配置 IPv6 总阻断规则（优先级高）
1.  登录 iKuai 管理后台 → **安全设置** → **ACL规则** → **添加规则**
2.  规则参数配置：
    | 配置项 | 参数值 |
    |--------|--------|
    | 协议栈 | IPv6 |
    | 协议 | 任意 |
    | 动作 | 阻断 |
    | 方向 | 转发 |
    | 连接方向匹配 | 原始方向 |
    | 目的地址 | 
    | 进接口 | Wan1 |
    | 出接口 | Lan1 |
    | 周期 | 全时段 |
    | 备注 | 阻断所有 IPv6 访问 |

#### 3.2 配置 IPv6 端口放行规则（优先级高于阻断规则）
1.  新建 ACL 规则，参数配置：
    | 配置项 | 参数值 |
    |--------|--------|
    | 协议栈 | IPv6 |
    | 协议 | TCP |
    | 动作 | 允许 |
    | 方向 | 转发 |
    | 连接方向匹配 | 关闭 |
    | 目的地址 |
    | 后缀匹配 | 开启 |
    | 匹配内容 | `::911/::fff`、<br>`::25df:XXXX:XXXX:XXXX/::ffff:ffff:ffff:ffff` |
    | 目的端口 | 443,2053 |
    | 进接口 | Wan1 |
    | 出接口 | Lan1 |
    | 周期 | 全时段 |
    | 备注 | 允许 IPv6 访问 |

### 4. Lucky 工具配置（DDNS + 反向代理）
**前置条件**：宿主机已安装 Lucky 工具（下载地址：https://lucky666.cn）
#### 4.1 动态域名（DDNS）配置
**目标**：将域名与宿主机公网IPv6地址绑定
1.  打开 Lucky 管理界面 → 进入 **动态域名** 模块
2.  添加两条 AAAA 类型记录（IPv6地址专用）：

    记录1：
    | 配置项 | 参数值 |
    |--------|--------|
    | 记录名 | `xds.net` |
    | 同步开关 | 开启 |
    | 记录类型 | AAAA（IPV6） |
    | TTL | 自动 |
    
    记录2（泛域名）：
    | 配置项 | 参数值 |
    |--------|--------|
    | 记录名 | `*.vm.xds.net` |
    | 同步开关 | 开启 |
    | 记录类型 | AAAA（IPV6） |
    | TTL | 自动 |

#### 4.2 Web 反向代理配置
**目标**：实现 443 端口到 2053 端口的映射，以及域名到宿主机内网的转发
##### 4.2.1 端口 2053 代理规则（核心转发规则）
| 配置项 | 参数值 |
|--------|--------|
| 规则名称 | Web_Proxy_2053 |
| 监听类型 | IPv6 |
| 监听端口 | **2053** |
| 防火墙自动放行 | 开启 |
| TLS | 启用 |
| 子规则名称 | Web |
| 服务类型 | 反向代理 |
| 前端地址 | web.vm.xds.net |
| 后端地址 | http://192.168.33.100:3335 |
| 忽略后端TLS证书验证 | 是 |

##### 4.2.2 端口 443 代理规则（无端口访问适配）
| 配置项 | 参数值 |
|--------|--------|
| 规则名称 | Web_Proxy_443 |
| 监听类型 | IPv6 |
| 监听端口 | **443** |
| 防火墙自动放行 | 开启 |
| TLS | 启用 |
| 子规则名称 | Web |
| 服务类型 | 反向代理 |
| 前端地址 | web.vm.xds.net |
| 后端地址 | https://web.vm.xds.net:2053 |
| 忽略后端TLS证书验证 | 是 |

### 5. 宿主机 IPv6 到 IPv4 端口转发配置
**目标**：实现 IPv6 公网请求到 IPv4 内网的转发
1.  以 **管理员身份** 打开 PowerShell/CMD
2.  执行 `netsh interface portproxy` 命令添加转发规则（以下命令每次只能执行一条，且要退出360卫士才能执行命令）：
    ```cmd
    netsh interface portproxy add v6tov4 listenaddress=240e:XXXX:XXXX:XXXX::911 listenport=9000 connectaddress=192.168.100.102 connectport=9000
    netsh interface portproxy add v6tov4 listenaddress=240e:XXXX:XXXX:XXXX::911 listenport=8081 connectaddress=192.168.100.103 connectport=80
    netsh interface portproxy add v6tov4 listenaddress=240e:XXXX:XXXX:XXXX::911 listenport=8080 connectaddress=192.168.100.104 connectport=80
    ```
3.  命令补充说明：
    - 查看所有规则：`netsh interface portproxy show all`
    - 清除所有规则：`netsh interface portproxy reset`
    - 批量配置：编写 `.bat` 脚本批量执行命令，提升效率

## 四、验证与排障
1.  **内网验证**：宿主机访问 `http://192.168.33.100:3335`，确认是否能正常跳转至虚拟机服务
2.  **IPv6 验证**：外网设备通过 `https://[宿主机公网IPv6]:3335` 访问，检查连通性
3.  **域名验证**：外网设备访问 `https://web.vm.xds.net`，确认是否无需端口即可访问
4.  **排障要点**
    - 检查 VMware 端口转发规则是否生效
    - 确认防火墙入站规则与路由器 ACL 规则无冲突
    - 验证 Lucky 域名解析状态与反向代理配置
