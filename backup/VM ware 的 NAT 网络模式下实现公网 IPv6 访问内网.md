# 问题：

在 VM Ware 的 **NAT 网络模式**下，在宿主机通过端口映射（转发），实现访问宿主机 http://192.168.33.100:8080 就能到达虚拟机 http://192.168.100.104:80， 同时解决公网 IPv6 访问内网。

# 解决方法：

要在 Windows 10 上实现这个复杂的网络需求，你需要完成**三步配置**。因为你的目标是让外网通过宿主机的 IP:8080 访问到虚拟机的 80 端口，这不仅仅是“放行防火墙”，核心在于**端口映射（转发）**。

**由于涉及到 IPv6 和 IPv4 的双栈访问**，我们需要确保流量能正确从宿主机“**跳转**”到虚拟机。

以下是详细的实现步骤：

### 🎯 最终网络目标
*   **访问入口（宿主机）：** IPv4 地址 192.168.33.100:8080 和 IPv6 地址 假设为 2001:db8::100。
*   **实际服务（虚拟机）：** IPv4 地址 192.168.100.104:80。
*   **效果：** 无论是（内网访问）http://192.168.33.100:8080 还是（外网访问） http://[2001:db8::100]:8080，看到的都是虚拟机 http://192.168.100.104 的网页。

## ⚙️ 第一步：配置端口映射（核心步骤）

Windows 自带的 netsh 工具可以实现 TCP 层的转发。你需要以**管理员身份**打开 CMD 或 PowerShell。

### 1.1 配置 IPv4 映射
将宿主机的 8080 端口流量，转发给虚拟机的 80 端口：

``` cmd
netsh interface portproxy add v4tov4 listenaddress=192.168.33.100 listenport=8080 connectaddress=192.168.100.104 connectport=80
```
### 1.2 配置 IPv6 映射
为了让外网 IPv6 访问，你需要添加一个 IPv6 到 IPv4 的映射（因为虚拟机服务通常是 IPv4 的 80 端口）：

``` cmd
netsh interface portproxy add v6tov4 listenaddress=2001:db8::100 listenport=8080 connectaddress=192.168.100.104 connectport=80
```

* **⚠️ 注意：** 请将 **2001:db8::100** 替换为你的宿主机实际的 IPv6 地址。

### 1.3 验证映射是否成功
输入以下命令查看是否出现刚才添加的两条规则：

``` cmd
netsh interface portproxy show all
```

<img width="663" height="225" alt="Image" src="https://github.com/user-attachments/assets/bd9b468a-e648-4bfc-8a38-fbaadc4998ef" />

<br><br>

## 🔥 第二步：配置 Windows 防火墙（放行端口）

映射配置好后，Windows 防火墙可能会拦截外部的连接请求，必须手动放行。

2.1 放行宿主机的监听端口（8080）
我们需要允许外部通过 TCP 协议访问宿主机的 8080 端口。

**方法 A：图形界面**
1.  打开“高级安全 Windows Defender 防火墙”。
2.  点击 **“入站规则”** -> **“新建规则”**。
3.  选择 **“端口”** -> 下一步 -> 选择 **TCP** -> 特定本地端口输入 **8080**。
4.  选择 **“允许连接”**。
5.  配置文件（域、专用、公用） **全选**。
6.  随便命名（如 Proxy_8080）完成。

**方法 B：命令行（快速）**

``` cmd
netsh advfirewall firewall add rule name="Allow_8080" dir=in action=allow protocol=TCP localport=8080
```

## ⚠️ 第三步：检查虚拟机网络模式（关键）

为了让宿主机能成功把流量“转给”虚拟机，请检查你的虚拟机软件（VMware/VirtualBox）设置：

1.  **不要使用“仅主机模式”：** 如果是仅主机模式，宿主机虽然能访问虚拟机，但外部同事无法通过宿主机 IP 访问到虚拟机。
2.  **推荐使用“桥接模式”：** 确保虚拟机 192.168.100.104 和宿主机在同一个局域网网段（或者路由互通）。如果虚拟机在 192.168.100.x，宿主机在 192.168.33.x，请确保路由器开启了互通，或者虚拟机设置为桥接到物理网卡。
3.  **测试连通性：** 在宿主机上 ping 192.168.100.104，如果能通，说明转发链路是通的。

## 🧪 最终测试

完成上述配置后，请按顺序测试：

1.  **宿主机自测：**
    *   浏览器访问 http://127.0.0.1:8080，看是否显示虚拟机的页面。
2.  **局域网测试 (IPv4)：**
    *   浏览器访问 http://192.168.33.100:8080。
3.  **在外网测试 (IPv6)：**
    *   在外网访问 http://[2001:db8::100]:8080 （注意 IPv6 地址需要用方括号括起来）。

## 💡 常见问题排查
*   **如果提示“连接被拒绝”：** 通常是防火墙没关或没放行，或者虚拟机网络不通。
*   **如果提示“无法访问此网站”：** 通常是端口映射命令写错了，或者宿主机 IP 地址填错了。
*   **删除规则命令：** 如果配置错了，可以用这个命令删除映射：

``` cmd
    netsh interface portproxy delete v4tov4 listenaddress=192.168.33.100 listenport=8080
    netsh interface portproxy delete v6tov4 listenaddress=2001:db8::100 listenport=8080
```

<br><br>